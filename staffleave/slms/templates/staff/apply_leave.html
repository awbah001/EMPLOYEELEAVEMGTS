{% extends 'base.html' %}
{% load static %}

{% block title %}Apply for Leave - Employee Dashboard{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="modern-card" style="background: var(--gradient-primary); color: var(--white); margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="width: 50px; height: 50px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i class="material-icons" style="font-size: 1.5rem;">add_circle</i>
        </div>
        <div>
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Apply for Leave</h2>
            <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">Submit your leave request for approval</p>
        </div>
    </div>
</div>

<!-- Leave Application Form -->
<div class="modern-card">
    <!-- Warning: User is currently on leave -->
    {% if is_on_leave and current_leave %}
    <div class="alert alert-warning" style="margin-bottom: 1.5rem; background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 1.25rem; border-radius: var(--radius-md);">
        <div style="display: flex; align-items: flex-start; gap: 1rem;">
            <i class="material-icons" style="font-size: 24px; color: #f59e0b; flex-shrink: 0;">warning</i>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; font-weight: 600; color: #92400e;">You Are Currently On Leave</h3>
                <p style="margin: 0 0 0.75rem 0; line-height: 1.6;">
                    You cannot apply for a new leave because you are currently on approved leave. Please wait until your current leave period ends before submitting a new application.
                </p>
                <div style="background: rgba(255, 255, 255, 0.5); padding: 0.75rem; border-radius: var(--radius-sm); margin-top: 0.75rem;">
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; font-size: 0.875rem;">
                        <strong style="color: #92400e;">Leave Type:</strong>
                        <span>{{ current_leave.leave_type_name|default:current_leave.leave_type.name|default:"N/A" }}</span>
                        <strong style="color: #92400e;">From:</strong>
                        <span>{{ current_leave.from_date|date:"F d, Y" }}</span>
                        <strong style="color: #92400e;">To:</strong>
                        <span>{{ current_leave.to_date|date:"F d, Y" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Success/Error Messages -->
                        {% if messages %}
                        {% for message in messages %}
                         {% if message.tags == 'error' %}
                <div class="alert alert-error" style="margin-bottom: 1.5rem;">
                    <i class="material-icons" style="font-size: 16px; margin-right: 8px;">error_outline</i>
                      {{message}}
                          </div>
            {% elif message.tags == 'success' %}
                <div class="alert alert-success" style="margin-bottom: 1.5rem;">
                    <i class="material-icons" style="font-size: 16px; margin-right: 8px;">check_circle</i>
                      {{message}}
                          </div>
                       {% endif %}
                        {% endfor %}
                       {% endif %}
                       
    <form method="POST" action="{% url 'staff_apply_leave_save' %}" enctype="multipart/form-data" style="max-width: 700px;" id="leave-application-form" {% if is_on_leave %}onsubmit="return false;"{% endif %}>
                           {% csrf_token %}
        
        <!-- Leave Type Section -->
        <div style="margin-bottom: 2rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="material-icons" style="color: var(--primary-blue);">category</i>
                Leave Information
            </h3>
            
            <div class="form-group">
                <label for="leave_type">Leave Type *</label>
                <div style="position: relative;">
                    <i class="material-icons input-icon">event_available</i>
                    <select id="leave_type" name="leave_type" class="form-input" required style="padding-left: 2.5rem;">
                        <option value="">Choose Leave Type</option>
                        {% for leave_type in leave_types %}
                        <option value="{{ leave_type.id }}" data-name="{{ leave_type.name }}" data-description="{{ leave_type.description|default:'' }}">{{ leave_type.name }}</option>
                        {% empty %}
                        <option value="" disabled>No leave types available. Please contact HR.</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="leave-type-info" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); display: none;">
                    <!-- Leave type descriptions will be shown here -->
                </div>
                {% if leave_balances %}
                <div style="margin-top: 1rem; padding: 1rem; background: var(--light-gray); border-radius: var(--radius-md);">
                    <div style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Your Leave Balances:</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                        {% for balance in leave_balances %}
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            <span style="font-weight: 500;">{{ balance.leave_type.name }}:</span>
                            <span style="color: {% if balance.days_remaining > 0 %}#10b981{% else %}#ef4444{% endif %}; font-weight: 600;">{{ balance.days_remaining }} days</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Date Selection Section -->
        <div style="margin-bottom: 2rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="material-icons" style="color: var(--primary-blue);">date_range</i>
                Leave Duration
            </h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label for="from_date">From Date *</label>
                    <div style="position: relative;">
                        <i class="material-icons input-icon">event</i>
                        <input type="date" id="from_date" name="from_date" class="form-input" required min="{% now 'Y-m-d' %}">
                               </div>
                           </div>
                
                <div class="form-group">
                    <label for="to_date">To Date *</label>
                    <div style="position: relative;">
                        <i class="material-icons input-icon">event</i>
                        <input type="date" id="to_date" name="to_date" class="form-input" required min="{% now 'Y-m-d' %}">
                    </div>
                               </div>
                           </div>
            
            <!-- Duration Display -->
            <div id="duration-display" style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius-md); display: flex; align-items: center; gap: 0.5rem; display: none;">
                <i class="material-icons" style="color: var(--primary-blue);">access_time</i>
                <span id="duration-text" style="font-weight: 500; color: var(--text-primary);">Duration will be calculated automatically</span>
                               </div>
                           </div>
        
        <!-- Reason Section -->
        <div style="margin-bottom: 2rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="material-icons" style="color: var(--primary-blue);">message</i>
                Reason for Leave
            </h3>
            
            <div class="form-group">
                <label for="message">Detailed Reason *</label>
                <div style="position: relative;">
                    <i class="material-icons input-icon" style="top: 1rem;">edit</i>
                    <textarea id="message" name="message" class="form-input" placeholder="Please provide a detailed reason for your leave request..." rows="5" required style="padding-left: 2.5rem; resize: vertical; min-height: 120px;"></textarea>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    Be specific about your leave requirements to help with approval process
                </div>
              </div>
        </div>
        
        <!-- Supporting Document Section -->
        <div style="margin-bottom: 2rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="material-icons" style="color: var(--primary-blue);">attach_file</i>
                Supporting Document (Optional)
            </h3>
            
            <div class="form-group">
                <label for="supporting_document">Upload Document</label>
                <div style="position: relative;">
                    <input type="file" id="supporting_document" name="supporting_document" class="form-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="padding: 0.75rem;">
                </div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    <i class="material-icons" style="font-size: 0.875rem; vertical-align: middle;">info</i>
                    Accepted formats: PDF, DOC, DOCX, JPG, PNG (Max 5MB). Medical certificate required for sick leave exceeding 3 days.
                </div>
                <div id="file-preview" style="margin-top: 1rem; padding: 1rem; background: var(--light-gray); border-radius: var(--radius-md); display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="material-icons" style="color: var(--primary-blue);">description</i>
                            <span id="file-name" style="font-weight: 500;"></span>
                            <span id="file-size" style="color: var(--text-secondary); font-size: 0.875rem;"></span>
                        </div>
                        <button type="button" id="remove-file" style="background: none; border: none; color: var(--error-red); cursor: pointer; padding: 0.25rem;">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                </div>
              </div>
        </div>
        
        <!-- Leave Guidelines -->
        <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(45, 90, 160, 0.05); border: 1px solid rgba(45, 90, 160, 0.1); border-radius: var(--radius-lg);">
            <h4 style="margin: 0 0 1rem 0; color: var(--primary-blue); display: flex; align-items: center; gap: 0.5rem;">
                <i class="material-icons">info</i>
                Leave Application Guidelines
            </h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); line-height: 1.6;">
                <li>Submit your leave application at least 3 days in advance for casual leave</li>
                <li>Medical certificate required for sick leave exceeding 3 days (upload as supporting document)</li>
                <li>Upload any supporting documents (medical certificates, invitation letters, etc.)</li>
                <li>All leave applications are subject to approval by your supervisor and HR</li>
                <li>You will receive notification once your application is reviewed</li>
                <li>Ensure your work responsibilities are covered during your absence</li>
            </ul>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--medium-gray);">
            <a href="{% url 'staff_home' %}" class="btn-secondary" style="width: auto; padding: 0.875rem 1.5rem; min-width: 150px; justify-content: center;">
                <i class="material-icons" style="font-size: 1rem; margin-right: 0.5rem;">arrow_back</i>
                Cancel
            </a>
            <button type="submit" class="btn-primary" style="width: auto; padding: 0.875rem 1.5rem; min-width: 150px; justify-content: center;" {% if is_on_leave %}disabled{% endif %} id="submit-btn">
                <i class="material-icons" style="font-size: 1rem; margin-right: 0.5rem;">send</i>
                Submit Application
            </button>
        </div>
    </form>
</div>

<!-- Additional Styles -->
<style>
/* Select dropdown styling */
select.form-input {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
    appearance: none;
}

/* Date input styling */
input[type="date"].form-input {
    background-image: none;
}

/* Textarea styling */
textarea.form-input {
    resize: vertical;
    font-family: inherit;
}

/* Responsive form grid */
@media (max-width: 768px) {
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    div[style*="justify-content: flex-end"] {
        justify-content: stretch !important;
    }
    
    div[style*="justify-content: flex-end"] .btn-primary,
    div[style*="justify-content: flex-end"] .btn-secondary {
        flex: 1;
    }
}

/* Form validation styles */
.form-input:invalid:not(:focus) {
    border-color: #ef4444;
}

.form-input:valid:not(:focus) {
    border-color: #10b981;
}

/* Loading state for submit button */
.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Duration display animation */
#duration-display {
    transition: all 0.3s ease;
}

#duration-display.show {
    display: flex !important;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveTypeSelect = document.getElementById('leave_type');
    const leaveTypeInfo = document.getElementById('leave-type-info');
    const fromDateInput = document.getElementById('from_date');
    const toDateInput = document.getElementById('to_date');
    const durationDisplay = document.getElementById('duration-display');
    const durationText = document.getElementById('duration-text');
    
    // Show leave type information
    leaveTypeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const description = selectedOption.getAttribute('data-description');
        const name = selectedOption.getAttribute('data-name');
        
        if (description && description.trim() !== '') {
            leaveTypeInfo.textContent = description;
            leaveTypeInfo.style.display = 'block';
        } else if (name) {
            // Fallback descriptions if no description in database
            const fallbackDescriptions = {
                'Casual Leave': 'Short-term leave for personal reasons. Usually limited to a few days per month.',
                'Earned Leave': 'Annual leave that you have earned through continuous service. Can be used for vacations.',
                'Sick Leave': 'Leave for medical reasons. Medical certificate may be required for extended periods.',
                'Maternity Leave': 'Leave for female employees during and after childbirth. Extended duration available.',
                'Paternity Leave': 'Leave for male employees following the birth of their child.'
            };
            if (fallbackDescriptions[name]) {
                leaveTypeInfo.textContent = fallbackDescriptions[name];
                leaveTypeInfo.style.display = 'block';
            } else {
                leaveTypeInfo.style.display = 'none';
            }
        } else {
            leaveTypeInfo.style.display = 'none';
        }
    });
    
    // Calculate duration
    function calculateDuration() {
        const fromDate = new Date(fromDateInput.value);
        const toDate = new Date(toDateInput.value);
        
        if (fromDate && toDate && fromDate <= toDate) {
            const duration = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
            const weekends = calculateWeekends(fromDate, toDate);
            const workingDays = duration - weekends;
            
            durationText.innerHTML = `
                <strong>Total Duration:</strong> ${duration} day${duration > 1 ? 's' : ''} 
                <span style="margin-left: 1rem; color: var(--text-secondary);">
                    (${workingDays} working day${workingDays > 1 ? 's' : ''}, ${weekends} weekend${weekends > 1 ? 's' : ''})
                </span>
            `;
            durationDisplay.classList.add('show');
        } else {
            durationDisplay.style.display = 'none';
        }
    }
    
    // Calculate weekends in date range
    function calculateWeekends(startDate, endDate) {
        let weekends = 0;
        const currentDate = new Date(startDate);
        
        while (currentDate <= endDate) {
            const dayOfWeek = currentDate.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                weekends++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        return weekends;
    }
    
    // Date validation and duration calculation
    fromDateInput.addEventListener('change', function() {
        toDateInput.min = this.value;
        if (toDateInput.value && toDateInput.value < this.value) {
            toDateInput.value = this.value;
        }
        calculateDuration();
    });
    
    toDateInput.addEventListener('change', function() {
        if (this.value < fromDateInput.value) {
            this.value = fromDateInput.value;
        }
        calculateDuration();
    });
    
    // Form submission with loading state
    const leaveForm = document.getElementById('leave-application-form');
    const submitBtn = document.getElementById('submit-btn');
    const isOnLeave = {{ is_on_leave|yesno:"true,false" }};
    
    if (leaveForm) {
        leaveForm.addEventListener('submit', function(e) {
            // Prevent submission if user is on leave
            if (isOnLeave) {
                e.preventDefault();
                alert('You cannot apply for leave while you are currently on leave. Please wait until your current leave period ends.');
                return false;
            }
            
            const originalContent = submitBtn.innerHTML;
            
            // Basic form validation
            if (!leaveTypeSelect.value || !fromDateInput.value || !toDateInput.value || !document.getElementById('message').value.trim()) {
                e.preventDefault();
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div>Submitting Application...';
            
            // Re-enable after 10 seconds (fallback)
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
            }, 10000);
        });
    }
    
    // Disable all form inputs if user is on leave
    if (isOnLeave) {
        const formInputs = leaveForm.querySelectorAll('input, select, textarea, button[type="submit"]');
        formInputs.forEach(input => {
            if (input.type !== 'hidden' && input.id !== 'csrfmiddlewaretoken') {
                input.disabled = true;
                input.style.opacity = '0.6';
                input.style.cursor = 'not-allowed';
            }
        });
    }
    
    // Real-time form validation
    document.querySelectorAll('.form-input[required]').forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                this.style.borderColor = '#ef4444';
            } else {
                this.style.borderColor = '#10b981';
            }
        });
        
        input.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                this.style.borderColor = '#10b981';
            }
        });
    });
    
    // Character counter for message
    const messageTextarea = document.getElementById('message');
    const messageGroup = messageTextarea.closest('.form-group');
    
    const charCounter = document.createElement('div');
    charCounter.style.cssText = 'font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; text-align: right;';
    messageGroup.appendChild(charCounter);
    
    messageTextarea.addEventListener('input', function() {
        const length = this.value.length;
        charCounter.textContent = `${length} characters`;
        
        if (length < 10) {
            charCounter.style.color = '#ef4444';
        } else if (length > 500) {
            charCounter.style.color = '#f59e0b';
        } else {
            charCounter.style.color = 'var(--text-secondary)';
        }
    });
    
    // Initialize character counter
    messageTextarea.dispatchEvent(new Event('input'));
    
    // File upload handling
    const fileInput = document.getElementById('supporting_document');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFileBtn = document.getElementById('remove-file');
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (file) {
            // Check file size (5MB max)
            const maxSize = 5 * 1024 * 1024; // 5MB in bytes
            if (file.size > maxSize) {
                alert('File size exceeds 5MB. Please choose a smaller file.');
                fileInput.value = '';
                filePreview.style.display = 'none';
                return;
            }
            
            // Check file type
            const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
                alert('Invalid file type. Please upload PDF, DOC, DOCX, JPG, or PNG files only.');
                fileInput.value = '';
                filePreview.style.display = 'none';
                return;
            }
            
            // Display file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.style.display = 'block';
        } else {
            filePreview.style.display = 'none';
        }
    });
    
    removeFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        filePreview.style.display = 'none';
    });
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
});
</script>
        {% endblock %}