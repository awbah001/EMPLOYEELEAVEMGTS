{% extends 'base.html' %}
{% load static %}

{% block title %}Leave History - Staff Dashboard{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="modern-card" style="background: var(--gradient-primary); color: var(--white); margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 50px; height: 50px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="material-icons" style="font-size: 1.5rem;">history</i>
            </div>
            <div>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Your Leave History</h2>
                <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">Track all your leave applications and their status</p>
            </div>
        </div>
        <a href="{% url 'staff_apply_leave' %}" class="btn-secondary" style="background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.3); color: var(--white); width: auto; padding: 0.75rem 1rem;">
            <i class="material-icons" style="font-size: 1rem; margin-right: 0.5rem;">add_circle</i>
            Apply for Leave
        </a>
    </div>
</div>

<!-- Statistics Summary -->
{% if staff_leave_history %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <!-- Total Applications -->
    <div class="modern-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: var(--white); text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">{{staff_leave_history.count}}</div>
        <div style="font-size: 0.875rem; opacity: 0.9;">Total Applications</div>
    </div>
    
    <!-- Pending Applications -->
    <div class="modern-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: var(--white); text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">
            {% for leave in staff_leave_history %}{% if leave.status == 0 %}{{forloop.counter}}{% endif %}{% empty %}0{% endfor %}
        </div>
        <div style="font-size: 0.875rem; opacity: 0.9;">Pending Review</div>
    </div>
    
    <!-- Approved Applications -->
    <div class="modern-card" style="background: linear-gradient(135deg, #10b981 0%, #047857 100%); color: var(--white); text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">
            {% for leave in staff_leave_history %}{% if leave.status == 1 %}{{forloop.counter}}{% endif %}{% empty %}0{% endfor %}
        </div>
        <div style="font-size: 0.875rem; opacity: 0.9;">Approved</div>
    </div>
    
    <!-- Rejected Applications -->
    <div class="modern-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: var(--white); text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">
            {% for leave in staff_leave_history %}{% if leave.status == 2 %}{{forloop.counter}}{% endif %}{% empty %}0{% endfor %}
        </div>
        <div style="font-size: 0.875rem; opacity: 0.9;">Rejected</div>
    </div>
</div>
{% endif %}

<!-- Messages -->
{% if messages %}
    {% for message in messages %}
        {% if message.tags == 'error' %}
            <div class="alert alert-error" style="margin-bottom: 1.5rem;">
                <i class="material-icons" style="font-size: 16px; margin-right: 8px;">error_outline</i>
                {{message}}
            </div>
        {% elif message.tags == 'success' %}
            <div class="alert alert-success" style="margin-bottom: 1.5rem;">
                <i class="material-icons" style="font-size: 16px; margin-right: 8px;">check_circle</i>
                {{message}}
            </div>
        {% endif %}
    {% endfor %}
{% endif %}

<!-- Leave History Table -->
<div class="modern-card">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <i class="material-icons" style="color: var(--primary-blue);">list_alt</i>
            Leave Applications History
        </h3>
        {% if staff_leave_history %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;" id="status-filters">
            <button onclick="filterByStatus('all')" class="filter-btn active" data-status="all">All</button>
            <button onclick="filterByStatus('Pending')" class="filter-btn" data-status="pending">Pending</button>
            <button onclick="filterByStatus('Approved')" class="filter-btn" data-status="approved">Approved</button>
            <button onclick="filterByStatus('Rejected')" class="filter-btn" data-status="rejected">Rejected</button>
        </div>
        {% endif %}
    </div>
    
    {% if staff_leave_history %}
        <div class="table-container" style="overflow-x: auto; border-radius: var(--radius-lg); border: 1px solid var(--medium-gray);">
            <table class="modern-table" id="table_id">
                <thead>
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 120px;">Leave Type</th>
                        <th style="width: 120px;">Start Date</th>
                        <th style="width: 120px;">End Date</th>
                        <th style="width: 80px;">Duration</th>
                        <th>Reason</th>
                        <th style="width: 100px;">Document</th>
                        <th style="width: 120px;">Applied On</th>
                        <th style="width: 100px;">Status</th>
                    </tr>
                </thead>
                
                <tbody>
                    {% for leave in staff_leave_history %}
                    <tr data-status="{% if leave.status == 0 %}pending{% elif leave.status == 1 %}approved{% else %}rejected{% endif %}">
                        <td style="font-weight: 600; color: var(--primary-blue);">#{{leave.id}}</td>
                        <td>
                            <span class="status-badge" style="background: rgba(45, 90, 160, 0.1); color: var(--primary-blue); font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                {{leave.leave_type}}
                            </span>
                        </td>
                        <td style="color: var(--text-secondary);">
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <i class="material-icons" style="font-size: 1rem; color: var(--text-secondary);">event</i>
                                <span style="font-size: 0.875rem;">{{leave.from_date|date:"M d, Y"}}</span>
                            </div>
                        </td>
                        <td style="color: var(--text-secondary);">
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <i class="material-icons" style="font-size: 1rem; color: var(--text-secondary);">event</i>
                                <span style="font-size: 0.875rem;">{{leave.to_date|date:"M d, Y"}}</span>
                            </div>
                        </td>
                        <td style="color: var(--text-secondary); font-size: 0.875rem; text-align: center;">
                            <span class="duration-badge" style="background: var(--light-gray); padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-weight: 500;">
                                <!-- Duration will be calculated by JavaScript -->
                            </span>
                        </td>
                        <td style="max-width: 200px;">
                            <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.875rem;" title="{{leave.message}}">
                                {{leave.message}}
                            </div>
                        </td>
                        <td style="text-align: center;">
                            {% if leave.supporting_document %}
                                <a href="{{ leave.supporting_document.url }}" target="_blank" style="color: var(--primary-blue); text-decoration: none;" title="View Document">
                                    <i class="material-icons" style="font-size: 1.25rem;">attach_file</i>
                                </a>
                            {% else %}
                                <span style="color: var(--text-secondary); font-size: 0.875rem;">-</span>
                            {% endif %}
                        </td>
                        <td style="color: var(--text-secondary); font-size: 0.875rem;">
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <i class="material-icons" style="font-size: 1rem; color: var(--text-secondary);">schedule</i>
                                {{leave.created_at|date:"M d, Y"}}
                            </div>
                        </td>
                        <td>
                            {% if leave.status == 0 %}
                                <span class="status-pending">Pending</span>
                            {% elif leave.status == 1 %}
                                <span class="status-approved">Approved</span>
                            {% else %}
                                <span class="status-rejected">Rejected</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <!-- Empty State -->
        <div style="text-align: center; padding: 3rem 1rem;">
            <div style="width: 80px; height: 80px; background: var(--light-gray); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                <i class="material-icons" style="font-size: 2rem; color: var(--text-secondary);">history</i>
            </div>
            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">No Leave History</h4>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">You haven't submitted any leave applications yet. Start by applying for your first leave.</p>
            <a href="{% url 'staff_apply_leave' %}" class="btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                <i class="material-icons" style="font-size: 1rem; margin-right: 0.5rem;">add_circle</i>
                Apply for Leave
            </a>
        </div>
    {% endif %}
</div>

<!-- Additional Styles -->
<style>
/* Filter buttons */
.filter-btn {
    background: var(--light-gray);
    border: 1px solid var(--medium-gray);
    color: var(--text-secondary);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-btn:hover {
    background: var(--medium-gray);
    transform: translateY(-1px);
}

.filter-btn.active {
    background: var(--primary-blue);
    color: var(--white);
    border-color: var(--primary-blue);
}

/* Enhanced table responsiveness */
@media (max-width: 1200px) {
    .modern-table th:nth-child(6),
    .modern-table td:nth-child(6) {
        display: none;
    }
}

@media (max-width: 1024px) {
    .modern-table th:nth-child(5),
    .modern-table td:nth-child(5),
    .modern-table th:nth-child(7),
    .modern-table td:nth-child(7) {
        display: none;
    }
}

@media (max-width: 768px) {
    .modern-table th:nth-child(3),
    .modern-table td:nth-child(3),
    .modern-table th:nth-child(4),
    .modern-table td:nth-child(4) {
        display: none;
    }
    
    #status-filters {
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .filter-btn {
        text-align: center;
    }
    
    div[style*="justify-content: space-between"] {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
}

/* Statistics cards responsiveness */
@media (max-width: 768px) {
    div[style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
    }
}

/* Row highlight based on status */
tbody tr[data-status="pending"] {
    border-left: 3px solid #f59e0b;
}

tbody tr[data-status="approved"] {
    border-left: 3px solid #10b981;
}

tbody tr[data-status="rejected"] {
    border-left: 3px solid #ef4444;
}

/* Duration badge colors */
.duration-badge {
    background: var(--light-gray) !important;
    color: var(--text-primary) !important;
}
</style>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable with custom configuration
    if ($.fn.DataTable && document.getElementById('table_id')) {
        const table = $('#table_id').DataTable({
            "pageLength": 10,
            "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            "order": [[0, "desc"]], // Sort by ID descending (newest first)
            "language": {
                "search": "Search your leave history:",
                "lengthMenu": "Show _MENU_ applications",
                "info": "Showing _START_ to _END_ of _TOTAL_ applications",
                "infoEmpty": "No applications found",
                "infoFiltered": "(filtered from _MAX_ total applications)",
                "zeroRecords": "No matching applications found",
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Previous"
                }
            },
            "responsive": true
        });
        
        // Global table variable for filtering
        window.leaveTable = table;
    }
    
    // Calculate and display duration for each leave
    document.querySelectorAll('tbody tr').forEach(row => {
        const startDateText = row.cells[2]?.querySelector('span')?.textContent.trim();
        const endDateText = row.cells[3]?.querySelector('span')?.textContent.trim();
        const durationBadge = row.querySelector('.duration-badge');
        
        if (startDateText && endDateText && durationBadge) {
            const startDate = new Date(startDateText);
            const endDate = new Date(endDateText);
            
            if (!isNaN(startDate) && !isNaN(endDate)) {
                const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const durationText = duration === 1 ? '1 day' : `${duration} days`;
                durationBadge.textContent = durationText;
                
                // Color code duration
                if (duration <= 3) {
                    durationBadge.style.background = 'rgba(16, 185, 129, 0.1)';
                    durationBadge.style.color = '#10b981';
                } else if (duration <= 7) {
                    durationBadge.style.background = 'rgba(249, 115, 22, 0.1)';
                    durationBadge.style.color = '#f97316';
                } else {
                    durationBadge.style.background = 'rgba(45, 90, 160, 0.1)';
                    durationBadge.style.color = 'var(--primary-blue)';
                }
            }
        }
    });
    
    // Animate statistics counters
    const counters = document.querySelectorAll('[style*="font-size: 2rem"]');
    counters.forEach(counter => {
        const target = parseInt(counter.textContent);
        if (target > 0) {
            let current = 0;
            const increment = target / 20;
            const timer = setInterval(() => {
                current += increment;
                counter.textContent = Math.floor(current);
                if (current >= target) {
                    counter.textContent = target;
                    clearInterval(timer);
                }
            }, 50);
        }
    });
});

// Filter function for status
function filterByStatus(status) {
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => btn.classList.remove('active'));
    
    const activeBtn = document.querySelector(`[data-status="${status}"]`) || document.querySelector('[data-status="all"]');
    activeBtn.classList.add('active');
    
    if (window.leaveTable) {
        if (status === 'all') {
            window.leaveTable.column(7).search('').draw();
        } else {
            const statusText = status === 'pending' ? 'Pending' : 
                             status === 'approved' ? 'Approved' : 'Rejected';
            window.leaveTable.column(7).search(statusText).draw();
        }
    }
}

// Add tooltips for truncated messages
document.querySelectorAll('[title]').forEach(element => {
    element.addEventListener('mouseenter', function() {
        if (this.scrollWidth > this.clientWidth) {
            // Element is truncated, tooltip will show
        }
    });
});
</script>
{% endblock %}