{% extends 'base.html' %}
{% load static %}

{% block title %}System Settings - HarmonyLeave (E/SLMS){% endblock %}

{% block content %}
<!-- Page Header -->
<div class="modern-card" style="background: var(--gradient-primary); color: var(--white); margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="material-icons" style="font-size: 2rem;">settings</i>
            </div>
            <div>
                <h2 style="margin: 0; font-size: 1.75rem; font-weight: 600;">System Settings</h2>
                <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.875rem;">Manage system-wide configuration settings</p>
            </div>
        </div>
        <a href="{% url 'admin_home' %}" style="color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.1); border-radius: var(--radius-md); transition: background 0.2s ease;">
            <i class="material-icons" style="font-size: 1.25rem;">arrow_back</i>
            Back to Dashboard
        </a>
    </div>
</div>

<!-- Messages -->
{% if messages %}
    {% for message in messages %}
        {% if message.tags == 'success' %}
            <div class="succWrap" style="margin-bottom: 1.5rem;">
                <i class="material-icons" style="font-size: 18px; margin-right: 8px; vertical-align: middle;">check_circle</i>
                {{ message }}
            </div>
        {% elif message.tags == 'error' %}
            <div class="errorWrap" style="margin-bottom: 1.5rem;">
                <i class="material-icons" style="font-size: 18px; margin-right: 8px; vertical-align: middle;">error_outline</i>
                {{ message }}
            </div>
        {% endif %}
    {% endfor %}
{% endif %}

<!-- System Settings Tabs (General / Leave Policies / Notifications / Security) -->
<div class="modern-card" style="margin-bottom: 2rem;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:0.75rem;">
            <i class="material-icons" style="color: var(--primary-blue); font-size: 22px;">tune</i>
            <div>
                <div style="font-weight:700; color:var(--text-primary)">Configure system parameters and preferences</div>
                <div style="font-size:0.9rem; color:var(--text-secondary); margin-top:2px">Only administrators can update these values</div>
            </div>
        </div>
        <div style="display:flex; gap:0.5rem;">
            <button class="tab-btn active" data-tab="general" style="padding:0.5rem 0.75rem; border-radius:8px; background:var(--white); border:1px solid rgba(20,30,40,0.03);">General</button>
            <button class="tab-btn" data-tab="leave" style="padding:0.5rem 0.75rem; border-radius:8px; background:transparent; border:1px solid rgba(20,30,40,0.03);">Leave Policies</button>
            <button class="tab-btn" data-tab="notifications" style="padding:0.5rem 0.75rem; border-radius:8px; background:transparent; border:1px solid rgba(20,30,40,0.03);">Notifications</button>
            <button class="tab-btn" data-tab="security" style="padding:0.5rem 0.75rem; border-radius:8px; background:transparent; border:1px solid rgba(20,30,40,0.03);">Security</button>
        </div>
    </div>

    <div style="margin-top:1rem;">
        <!-- General -->
        <form method="POST" action="{% url 'admin_system_settings' %}" class="tab-panel" id="tab-general">
            {% csrf_token %}
            <input type="hidden" name="section" value="general">
            <div style="background:var(--white); border-radius: 8px; border: 1px solid rgba(20,30,40,0.03); padding: 1.25rem;">
                <h4 style="margin:0 0 0.5rem 0; font-weight:700;">General Settings</h4>
                <p style="margin:0 0 1rem 0; color:var(--text-secondary)">Basic system configuration</p>

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;">
                    <div>
                        <label class="form-label">Company Name</label>
                        <input name="company_name" value="{{ settings_map.company_name|default_if_none:'' }}" class="form-input" placeholder="Company display name" />
                    </div>

                    <div>
                        <label class="form-label">Timezone</label>
                        <select name="timezone" class="form-input">
                            {% with tz=settings_map.timezone|default_if_none:'' %}
                            <option value="UTC" {% if tz == 'UTC' %}selected{% endif %}>UTC</option>
                            <option value="UTC-5" {% if tz == 'UTC-5' %}selected{% endif %}>UTC-5 (Eastern Time)</option>
                            <option value="UTC+0" {% if tz == 'UTC+0' %}selected{% endif %}>UTC+0 (GMT)</option>
                            <option value="UTC+1" {% if tz == 'UTC+1' %}selected{% endif %}>UTC+1 (CET)</option>
                            <option value="UTC+3" {% if tz == 'UTC+3' %}selected{% endif %}>UTC+3 (Moscow)</option>
                            {% endwith %}
                        </select>
                    </div>

                    <div>
                        <label class="form-label">Working Days Per Week</label>
                        <input name="working_days_per_week" value="{{ settings_map.working_days_per_week|default:'5' }}" type="number" min="0" max="7" class="form-input" />
                    </div>

                    <div>
                        <label class="form-label">Maintenance Mode</label>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <label style="display:flex; align-items:center; gap:0.5rem;">
                                <input name="maintenance_mode" type="checkbox" {% if settings_map.maintenance_mode == 'True' or settings_map.maintenance_mode == 'true' or settings_map.maintenance_mode == '1' %}checked{% endif %} />
                                <span style="font-size:0.95rem; color:var(--text-secondary)">Temporarily disable site access</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div style="margin-top:1rem; display:flex; gap:0.5rem;">
                    <button type="submit" class="btn-primary">Save General</button>
                    <a class="btn-secondary" href="javascript:void(0)" onclick="document.getElementById('tab-general').reset();">Reset</a>
                </div>
            </div>
        </form>

        <!-- Leave Policies -->
        <form method="POST" action="{% url 'admin_system_settings' %}" class="tab-panel" id="tab-leave" style="display:none;">
            {% csrf_token %}
            <input type="hidden" name="section" value="leave_policies">
            <div style="background:var(--white); border-radius: 8px; border: 1px solid rgba(20,30,40,0.03); padding: 1.25rem;">
                <h4 style="margin:0 0 0.5rem 0; font-weight:700;">Leave Policies</h4>
                <p style="margin:0 0 1rem 0; color:var(--text-secondary)">Default policies applied across the organisation</p>

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;">
                    <div>
                        <label class="form-label">Maximum Carryover Days</label>
                        <input name="carryover_days" value="{{ settings_map.leave_carryover_days|default:'0' }}" class="form-input" type="number" min="0" />
                    </div>

                    <div>
                        <label class="form-label">Max Sick Leave / year</label>
                        <input name="max_sick_per_year" value="{{ settings_map.leave_max_sick_per_year|default:'10' }}" class="form-input" type="number" min="0" />
                    </div>
                </div>

                <div style="margin-top:1rem; display:flex; gap:0.5rem;">
                    <button type="submit" class="btn-primary">Save Policies</button>
                    <a class="btn-secondary" href="javascript:void(0)" onclick="document.getElementById('tab-leave').reset();">Reset</a>
                </div>
            </div>
        </form>

        <!-- Notifications -->
        <form method="POST" action="{% url 'admin_system_settings' %}" class="tab-panel" id="tab-notifications" style="display:none;">
            {% csrf_token %}
            <input type="hidden" name="section" value="notifications">
            <div style="background:var(--white); border-radius: 8px; border: 1px solid rgba(20,30,40,0.03); padding: 1.25rem;">
                <h4 style="margin:0 0 0.5rem 0; font-weight:700;">Notifications</h4>
                <p style="margin:0 0 1rem 0; color:var(--text-secondary)">Email / in-app notification configuration</p>

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;">
                    <div>
                        <label class="form-label">Email Notifications</label>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <input type="checkbox" name="email_notifications" {% if settings_map.email_notifications_enabled == 'True' or settings_map.email_notifications_enabled == 'true' or settings_map.email_notifications_enabled == '1' %}checked{% endif %} />
                            <span style="color:var(--text-secondary)">Enable outgoing emails</span>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Sender Email Address</label>
                        <input name="email_sender" value="{{ settings_map.email_sender_address|default:'' }}" class="form-input" placeholder="no-reply@example.com" />
                    </div>
                </div>

                <div style="margin-top:1rem; display:flex; gap:0.5rem;">
                    <button type="submit" class="btn-primary">Save Notifications</button>
                    <a class="btn-secondary" href="javascript:void(0)" onclick="document.getElementById('tab-notifications').reset();">Reset</a>
                </div>
            </div>
        </form>

        <!-- Security -->
        <form method="POST" action="{% url 'admin_system_settings' %}" class="tab-panel" id="tab-security" style="display:none;">
            {% csrf_token %}
            <input type="hidden" name="section" value="security">
            <div style="background:var(--white); border-radius: 8px; border: 1px solid rgba(20,30,40,0.03); padding: 1.25rem;">
                <h4 style="margin:0 0 0.5rem 0; font-weight:700;">Security</h4>
                <p style="margin:0 0 1rem 0; color:var(--text-secondary)">Password rules and multi-factor auth</p>

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;">
                    <div>
                        <label class="form-label">Minimum Password Length</label>
                        <input name="password_min_length" value="{{ settings_map.password_min_length|default:'8' }}" type="number" min="4" class="form-input" />
                    </div>
                    <div>
                        <label class="form-label">Require 2FA</label>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <input type="checkbox" name="require_2fa" {% if settings_map.require_2fa == 'True' or settings_map.require_2fa == 'true' or settings_map.require_2fa == '1' %}checked{% endif %} />
                            <span style="color:var(--text-secondary)">Require two-factor authentication for sign in</span>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Login Lockout Threshold</label>
                        <input name="login_lockout_threshold" value="{{ settings_map.login_lockout_threshold|default:'5' }}" type="number" min="1" class="form-input" />
                    </div>
                    <div>
                        <label class="form-label">Login Lockout Minutes</label>
                        <input name="login_lockout_minutes" value="{{ settings_map.login_lockout_minutes|default:'15' }}" type="number" min="1" class="form-input" />
                    </div>
                </div>

                <div style="margin-top:1rem; display:flex; gap:0.5rem;">
                    <button type="submit" class="btn-primary">Save Security</button>
                    <a class="btn-secondary" href="javascript:void(0)" onclick="document.getElementById('tab-security').reset();">Reset</a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Tab switching logic
document.addEventListener('DOMContentLoaded', function(){
    const tabButtons = [...document.querySelectorAll('.tab-btn')];
    const panels = [...document.querySelectorAll('.tab-panel')];

    function setActive(tab) {
        tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
        panels.forEach(p => p.style.display = (p.id === 'tab-' + tab) ? '' : 'none');
    }

    tabButtons.forEach(b => {
        b.addEventListener('click', function(){ setActive(this.dataset.tab); });
    });
});
</script>

<!-- Existing Settings Table -->
<div class="modern-card">
    <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
        <i class="material-icons" style="color: var(--primary-blue);">list</i>
        Existing Settings ({{ settings|length }})
    </h3>
    
    {% if settings %}
        <div style="overflow-x: auto;">
            <table class="modern-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: var(--radius-lg); overflow: hidden;">
                <thead>
                    <tr style="background: var(--light-gray);">
                        <th style="padding: 1rem; font-weight: 600; color: var(--text-primary); text-align: left; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Key</th>
                        <th style="padding: 1rem; font-weight: 600; color: var(--text-primary); text-align: left; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Value</th>
                        <th style="padding: 1rem; font-weight: 600; color: var(--text-primary); text-align: left; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Description</th>
                        <th style="padding: 1rem; font-weight: 600; color: var(--text-primary); text-align: left; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Last Updated</th>
                        <th style="padding: 1rem; font-weight: 600; color: var(--text-primary); text-align: center; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for setting in settings %}
                        <tr style="border-bottom: 1px solid var(--medium-gray); transition: background 0.2s ease;">
                            <td style="padding: 1rem; color: var(--text-primary); font-weight: 600;">
                                <code style="background: rgba(45, 90, 160, 0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; color: var(--primary-blue);">
                                    {{ setting.key }}
                                </code>
                            </td>
                            <td style="padding: 1rem; color: var(--text-secondary);">
                                <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ setting.value }}">
                                    {{ setting.value }}
                                </div>
                            </td>
                            <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                                {{ setting.description|default:"â€”"|truncatewords:10 }}
                            </td>
                            <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                                {{ setting.updated_at|date:"M d, Y H:i" }}
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <a href="{% url 'admin_update_setting' setting.id %}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(45, 90, 160, 0.1); color: var(--primary-blue); border-radius: var(--radius-md); text-decoration: none; font-size: 0.875rem; font-weight: 500; transition: all 0.2s ease;">
                                    <i class="material-icons" style="font-size: 18px;">edit</i>
                                    Edit
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="material-icons" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">settings</i>
            <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">No settings found</p>
            <p style="font-size: 0.875rem; opacity: 0.7;">Add your first system setting using the form above</p>
        </div>
    {% endif %}
</div>

<style>
.form-input:focus {
    outline: none;
    border-color: var(--primary-blue) !important;
    box-shadow: 0 0 0 3px rgba(45, 90, 160, 0.1) !important;
}

.modern-table tr:hover {
    background: rgba(45, 90, 160, 0.02) !important;
}

a[href*="update_setting"]:hover {
    background: rgba(45, 90, 160, 0.2) !important;
    transform: translateY(-1px);
}

@media (max-width: 768px) {
    .modern-card {
        padding: 1rem;
    }
    
    .modern-table {
        font-size: 0.875rem;
    }
    
    .modern-table th,
    .modern-table td {
        padding: 0.75rem 0.5rem;
    }
}
</style>
{% endblock %}

